# PRD Addendum: Code Export

**Feature:** `code-export`
**Epic:** ZEST-F04
**Parent PRD:** `docs/prd.md`
**Status:** Approved
**Date:** 2026-02-22
**Priority:** P0

---

## 1. Feature Metadata

| Field | Value |
|-------|-------|
| Feature Name | Code Export |
| Feature Slug | `code-export` |
| Epic Code | `ZEST-F04` |
| Priority | P0 |
| Impacted Users | All users (anonymous + free + paid) |
| PRD Stories | US-12, US-13, US-14 |

---

## 2. User Stories

| ID | User Story | Acceptance Criteria | Priority |
|----|------------|---------------------|----------|
| US-12 | As a user, I want to export my UI as HTML/CSS so that I can use it in my projects | **Given** I have a finalized UI<br>**When** I click "Export" and select "HTML/CSS"<br>**Then** I download a ZIP containing `index.html` and `styles.css` | P0 |
| US-13 | As a user, I want to export as Tailwind CSS so that I can use it in modern projects | **Given** I am authenticated<br>**When** I click "Export" and select "Tailwind"<br>**Then** I download a ZIP with Tailwind-class HTML | P0 |
| US-14 | As a user, I want to preview the code before exporting so that I can verify quality | **Given** I click "View Code"<br>**When** the code panel opens<br>**Then** I see syntax-highlighted HTML/CSS | P1 |

---

## 3. Functional Requirements

### 3.1 Export Modal
- Triggered by "Export" button in editor toolbar
- Two format options: HTML/CSS | Tailwind CSS (with visual cards per format)
- "Tailwind CSS" option shows a lock icon and "Sign in required" tooltip for anonymous users
- Selected format shown with a check mark; default: the current `output_format` of the generation
- "Export" CTA button; "Preview Code" secondary action
- Download triggers immediately on confirm (no separate download page)

### 3.2 Export API Route
`POST /api/v1/exports` creates a ZIP and returns a temporary download URL:
1. Validate request: `generation_id`, `format`
2. Fetch HTML/CSS from `Generation` record
3. Apply post-processing: inject `<meta charset>`, `<meta viewport>`, add watermark comment for anonymous (BR-012)
4. For Tailwind format: ensure Tailwind CDN `<script>` is present in HTML (MVP approach)
5. Generate ZIP in memory (`archiver` or Go `archive/zip`)
6. Store ZIP temporarily (OS temp dir or object storage)
7. Return a signed download URL (or stream directly as a file response)
8. Persist `Export` record in PostgreSQL

### 3.3 Export Constraints
- Anonymous: HTML/CSS only; includes `<!-- Generated by Zest -->` watermark comment; Tailwind blocked
- Authenticated (free + paid): both formats; no watermark
- For both: output is human-readable (not minified â€” BR-013)

### 3.4 Code Preview (US-14)
- "View Code" button opens a slide-over panel with syntax-highlighted code
- Tabs: "HTML" | "CSS" (or single "HTML" tab for Tailwind output)
- Uses `highlight.js` or `prism.js` for syntax highlighting
- "Copy" button per tab
- "Export" CTA at bottom of preview panel (same action as toolbar button)

---

## 4. ERD Delta

Uses existing `Export` entity. No new entities.

---

## 5. API Contract

### POST /api/v1/exports

**Auth:** Optional (anonymous allowed for HTML/CSS only)

**Request:**
```json
{
  "generation_id": "uuid",
  "format": "html_css | tailwind"
}
```

**Response 201:**
```json
{
  "data": {
    "export_id": "uuid",
    "download_url": "string (signed or streamed)",
    "format": "html_css | tailwind",
    "file_size_bytes": 12400
  }
}
```

**Error Codes:**
| HTTP | Code | Condition |
|------|------|-----------|
| 400 | `VALIDATION_ERROR` | Invalid `generation_id` or `format` |
| 403 | `PLAN_LIMIT_EXCEEDED` | Anonymous user requests Tailwind export |
| 404 | `NOT_FOUND` | `generation_id` not found or not accessible |

---

## 6. Analytics Events

| Event | Trigger | Properties |
|-------|---------|------------|
| `export_initiated` | Export modal opened | `format_selected`, `generation_id`, `user_type` |
| `export_completed` | ZIP download starts | `format`, `file_size_bytes`, `generation_id` |
| `code_preview_opened` | "View Code" clicked | `format`, `generation_id` |
| `code_copied` | Copy button clicked in preview | `tab` (html/css) |

---

## 7. Open Questions

| ID | Question | Owner | Status |
|----|----------|-------|--------|
| CE-OQ-01 | Should ZIPs be stored persistently (S3/object storage) or ephemeral (streamed/temp dir)? | Tech | Open |
| CE-OQ-02 | Should exported Tailwind use CDN script tag (MVP) or a full Tailwind build? | Tech | Open |

---

## 8. Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-02-22 | AI Assistant | Initial version |
