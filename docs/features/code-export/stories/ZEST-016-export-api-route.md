# ZEST-016: Export API Route & ZIP Generation

**Epic:** ZEST-F04 (Code Export)
**Layer:** L3-backend
**Role:** Backend
**Estimation:** 5
**Priority:** Must

---

## Objective

Implement `POST /api/v1/exports`. Fetches the generation's HTML/CSS, applies post-processing (meta tags, watermark), generates a ZIP archive in memory, streams it as a file download, and persists an `Export` record.

## Technical Specifications

- **Proposed Files:**
  - `src/app/api/v1/exports/route.ts`
  - `src/lib/export-service.ts` (`buildZip(generation, format, isAuthenticated): Buffer`)
  - `src/lib/html-processor.ts` (`injectMeta(html)`, `addWatermark(html)`, `stripWatermark(html)`)
  - `src/schemas/export.schema.ts` (Zod schema)
- **Functions/Classes:**
  - `buildZip(generation, format, isAuthenticated)` → `Buffer` (in-memory ZIP)
  - `injectMeta(html)` → ensures `<meta charset="UTF-8">` and `<meta name="viewport">` present (BR-012)
  - `addWatermark(html)` → inserts `<!-- Generated by Zest -->` after `<body>` for anonymous
  - `stripWatermark(html)` → removes watermark comment for authenticated
- **API Endpoints:** `POST /api/v1/exports`
- **Data Models:** `Export` (Prisma)

## Acceptance Criteria (Technical)

- [ ] `POST /api/v1/exports` with valid `generation_id` returns file download (content-type `application/zip`, content-disposition `attachment`)
- [ ] ZIP for `html_css` contains `index.html` + `styles.css`
- [ ] ZIP for `tailwind` contains `index.html` only (CSS inline via Tailwind classes)
- [ ] Anonymous request for `tailwind` returns `403 PLAN_LIMIT_EXCEEDED`
- [ ] Exported HTML has `<meta charset="UTF-8">` and `<meta name="viewport" content="width=device-width, initial-scale=1">` (BR-012)
- [ ] Anonymous export HTML has `<!-- Generated by Zest -->` watermark; authenticated does not
- [ ] Exported HTML is NOT minified (BR-013)
- [ ] `Export` record created in PostgreSQL after successful export
- [ ] Unit tests for `injectMeta`, `addWatermark`, `buildZip`

## Business Rules & Logic

- BR-012: `<meta>` tag injection
- BR-013: output must be human-readable
- Anonymous Tailwind export blocked (Permission Matrix §2.2)

## Dependencies

- Depends on: ZEST-001 (Prisma, base setup)
- Depends on: ZEST-004 (`Generation` record must exist to export from)

## Definition of Done

- [ ] Code implemented
- [ ] Unit tests: `injectMeta`, `addWatermark`, `buildZip` (html_css and tailwind)
- [ ] Integration test: download ZIP, unzip, verify file structure and content
- [ ] Lint/Type check clear
